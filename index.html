<!DOCTYPE html>
<html>
  <head>
    <title>Memory exercise</title>
    <script src="http://code.jquery.com/jquery-1.11.0.min.js"></script>

    <style>
        @import url(http://fonts.googleapis.com/css?family=Handlee);

        * { margin: 0; padding: 0; }

        body {
            background-color: #333;
            font-family: 'Handlee', arial;
        }

        .memory {
            margin: 0 auto;
            padding-bottom: 100px;
            width: 1060px;
        }

        .game_name {
            color: #fff;
            font-size: 30px;
            margin-top: 20px;
            margin-bottom: 20px;
            text-align: left;
        }

        .generate_game {
            background-color: #777;
            border-radius: 6px;
            float: left;
            padding: 50px;
            text-align: center;
        }

        .generate_game input {
            background-color: #333;
            border: none;
            color: #e1e1e1;
            font-size: 24px;
            height: 45px;
            text-align: center;
            width: 100px;
        }

        .generate_game .generate_game_text {
            color: #000;
            display: inline;
            font-size: 24px;
        }

        .generate_game .generate_game_button {
            background-color: #333;
            border-radius: 4px;
            color: #e1e1e1;
            cursor: pointer;
            display: inline-block;
            margin-top: 30px;
            padding: 10px 6px 10px 10px;
            text-transform: uppercase;
        }

        .generate_game .generate_game_button:hover {
            background-color: #ccc;
            color: #000;
        }

        .game_admin_bar {
            height: 50px;
            margin-bottom: 20px;
            width: 100%;
        }

        .game_admin_bar .total_moves {
            color: #ccc;
            float: left;
            font-size: 16px;
        }

        .game_admin_bar .reset_button {
            background-color: #999;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
            float: right;
            padding: 10px 6px 10px 6px;
        }

        .game_board {
            float: left;
        }

        .game_board .memory_button {
            background-color: #BBBDBF;
            border-top: 1px solid #ccc;
            border-right: 1px solid #999;
            border-bottom: 1px solid #999;
            border-left: 1px solid #ccc;
            cursor: pointer;
            float: left;
            font-size: 30px;
            height: 125px;
            line-height: 125px;
            margin-right: 4px;
            margin-bottom: 4px;
            position: relative;
            text-align: center;
            overflow-y: hidden;
            vertical-align: middle;
            width: 125px;
        }

        .game_board :not(.match).memory_button:hover {
            border: 1px solid #000;
        }

        .pressed {
            background-color: #fff!important;
            border-top: 1px solid #666!important;
            border-right: 1px solid #ccc!important;
            border-bottom: 1px solid #ccc!important;
            border-left: 1px solid #666!important;
        }

        .left_square {
            clear: left;
        }

        .clear {
            clear: both;
        }

        .match {
            opacity: 0.4;
        }

        .highlight {
            background-color: #e1e1e1!important;
            cursor: default;
            opacity: 1!important;
        }

    </style>

  </head>
  <body>

    <div class='memory'>
        <div class='game_name'>Advanced JS - Memory Game</div>

        <div class='game_admin_bar' style="display:none;">
            <div class='total_moves'>Total Moves: <span>0</span></div>
            <div class='reset_button'>RESET</div>
        </div>

        <div class='generate_game'>
            <input type='text' value='10'>
            <div class='generate_game_text'>Matches To Find</div>
            <div class='clear'></div>
            <div class='generate_game_button'>Generate Gameboard</div>
        </div>

        <div class='game_board'></div>
        <div class='clear'></div>
    </div>

    <script>

    //Memory Object
    var memory = {

        cards : {
            card_array : [],
            match_sets : null,
            total_cards : null,
            shuffle_cards : null
        },

        game_board : {
            determine_row_size : null,
            game_won : null,
            generate_game_board : null,
            init_game_board : null,
            layout_cards : null,
            reset_game : null,
            row_size : null
        },

        game_play : {
            add_listeners : null,
            click_state : false,
            current_number : null,
            current_location : null,
            game_paused : false,
        },

        stats : {
            total_moves : 0
        }

    }

    memory.game_board.init_game_board = function( match_sets ) {

        //STORE MATCH SETS
        memory.cards.match_sets = match_sets;

        //TOTAL NUMBER OF SQUARES IN THE GRID
        memory.cards.total_cards = memory.cards.match_sets * 2;

        //DETERMINE THE NUMBER OF TILES IN A ROW
        memory.game_board.row_size = memory.game_board.determine_row_size();

        //PUSH 2 SETS OF NUMBERS INTO ARRAY FOR EACH MATCH_SET
        for ( var i = 0; i < match_sets; i++ ) {
            memory.cards.card_array.push(i);
            memory.cards.card_array.push(i);
        }

        //LAYOUT THE GAME BOARD
        memory.game_board.layout_cards();

    }

    memory.game_board.determine_row_size = function() {

        var square_root = Math.sqrt( memory.cards.total_cards );

        if ( square_root <= 8 && square_root % 1 === 0 ) {
            return square_root;
        }
        else if ( memory.cards.total_cards % 8 === 0) {
            return 8;
        }
        else if ( memory.cards.total_cards % 7 === 0) {
            return 7;
        }
        else if ( memory.cards.total_cards % 6 === 0) {
            return 6;
        }
        else if ( memory.cards.total_cards % 5 === 0) {
            return 5;
        }
        else if ( memory.cards.total_cards % 4 === 0) {
            return 4;
        }
        else if ( memory.cards.total_cards % 3 === 0) {
            return 3;
        }
        else if ( memory.cards.total_cards % 2 === 0) {
            return 2;
        }

    }

    //Shuffle the cards
    //1. determine number of cards to shuffle
    //2. select a random card from the array
    //3. swap the random card with the last unshuffled card
    memory.cards.shuffle_cards = function() {

        //TOTAL NUMBERS LEFT IN ARRAY
        var cards_left_to_shuffle = memory.cards.card_array.length;

        //LAST NUMBER IN ARRAY NOT YET SHUFFLED
        var last_number_in_array;

        //RANDOMLY SELECTED INDEX BASED ON CARDS LEFT TO SHUFFLE
        var random_index;

        // WHILE CARDS REMAINING TO SHUFFLE
        while ( cards_left_to_shuffle > 0 ) {

            //PICK A RANDOM INDEX BASED ON THE CARDS LEFT TO SHUFFLE
            random_index = Math.floor(Math.random() * cards_left_to_shuffle);

            //TOTAL NUMBERS IN ARRAY MINUS 1 TO MATCH 0 BASED INDEX
            cards_left_to_shuffle -= 1;

            //LAST NUMBER IN THE ARRAY TO SHUFFLE
            last_number_in_array = memory.cards.card_array[cards_left_to_shuffle];

            /* ==== SWAP THE CARDS ==== */
            //LAST NUMBER IN ARRAY IS EQUAL TO RANDOM INDEX
            memory.cards.card_array[cards_left_to_shuffle] = memory.cards.card_array[random_index];

            //RANDOM INDEX IS EQUAL TO LAST NUMBER IN THE ARRAY
            memory.cards.card_array[random_index] = last_number_in_array;
        }

    }

    //GENERATE GAME BOARD
    memory.game_board.layout_cards = function() {

        //SHUFFLE THE CARDS
        memory.cards.shuffle_cards();

        //WHICH COLUMN THE CARD IS PLACED
        var j = 1;

        var memory_button_html = '';

        for ( var i = 0; i < memory.cards.total_cards; i++ ) {

            if ( j === 1 ) {
                memory_button_html = '<div class="memory_button left_square" data-location="' + i + '" data-number="' + memory.cards.card_array[i] + '"></div>';
                j++;
            }

            else if ( j < memory.game_board.row_size ) {
                memory_button_html = '<div class="memory_button" data-location="' + i + '" data-number="' + memory.cards.card_array[i] + '"></div>';
                j++;
            }

            else {
                memory_button_html = '<div class="memory_button" data-location="' + i + '" data-number="' + memory.cards.card_array[i] + '"></div>';
                j = 1;
            }

            //DEAL CARD TO THE GAME BOARD
            $('.game_board').append(memory_button_html);
        }

        memory.game_play.add_listeners();
    }

    memory.game_board.generate_game_board = function() {
        var matches_to_find = $('.memory .generate_game input').val();

        //CHECK IF INPUT BOX IS EMPTY
        if ( $('.memory .generate_game input').length === 0 ) {
            return;
        }

        //CHECK IF 0 WAS USED AS INPUT VALUE
        if ( matches_to_find == 0 ) {
            return;
        }

        //MAKE SURE AN INTEGER WAS ENTERED
        var matches_to_find_number = Number(matches_to_find);

        if ( Math.floor( matches_to_find_number ) == matches_to_find_number ) {
            //console.log('generate game board');

            $('.generate_game').hide();

            memory.game_board.init_game_board(matches_to_find);

            $('.game_admin_bar').show();
        }
        else {
            alert('please enter a valid integer');
        }
    }

    memory.game_board.game_won = function() {

        var highlight_timer = 100;

        $('.game_board .memory_button').each(function(){

            var that = $(this);

            highlight_timer += 100;

            setTimeout( function(){

                that.addClass('highlight');

            }, highlight_timer);

        });
    }

    memory.game_play.add_listeners = function() {

        memory.game_play.click_state = false;
        memory.game_play.current_number = null;
        memory.game_play.current_location = null;

        $('.memory_button').on('click', function() {

            //CHECK IF THE BOARD IS CLICKABLE
            if ( memory.game_play.game_paused === true ) {
                return;
            }

            //CHECK IF THE TILE HAS ALREADY BEEN MATCHED
            if ( $(this).hasClass('match') ) {
                return;
            }

            //SET THE MEMORY BUTTON THAT WAS CLICKED TO ACTIVE
            $(this).addClass('active');

            //Step 1. CHECK IF FIRST CLICK OR SECOND CLICK
            if ( memory.game_play.click_state === false ) {
                //FIRST CLICK

                //store the selected button number
                var selected_number = $(this).attr('data-number');

                //set the current number
                memory.game_play.current_number = selected_number;

                //set the current location
                memory.game_play.current_location = $(this).attr('data-location');

                //show the button number
                $(this).html(selected_number);

                //set click state to true for second click
                memory.game_play.click_state = true;
            }
            else {
                //SECOND CLICK

                //selected data location
                var selected_location = $(this).attr('data-location');

                //IF THE USER CLICKED THE SAME TILE
                if ( selected_location === memory.game_play.current_location ) {
                    return;
                }

                //reset the click state
                memory.game_play.click_state = false;

                //store the selected number
                var selected_number = $(this).attr('data-number');

                //show the number
                $(this).html(selected_number);

                if ( selected_number == memory.game_play.current_number ) {
                    //THERE IS A MATCH

                    //reset the current number
                    memory.game_play.current_number = '';

                    $('.active').addClass('match');
                    $('.active').removeClass('active');

                    memory.cards.match_sets -= 1;
                    console.log('total sets to match: ', memory.cards.match_sets);

                    if ( memory.cards.match_sets === 0 ) {
                        console.log('game won');
                        memory.game_board.game_won();
                    }

                }
                else {
                    //THER IS NOT A MATCH

                    //PREVENT SELECTING A NEW TILE
                    memory.game_play.game_paused = true;

                    setTimeout(function () {

                        memory.game_play.current_number = null;
                        memory.game_play.current_location = null;

                        //HIDE THE NUMBERS THAT WERE NOT MATCHED
                        $('.active').empty();

                        //RESET ACTIVE TILES
                        $('.active').removeClass('active');

                        //USER CAN NOW SELECT A NEW TILE
                        memory.game_play.game_paused = false;

                    }, 1000);
                }

                //INCREMENT SCORE
                memory.stats.total_moves += 1;

                //SHOW THE SCORE IN THE DOM
                $('.game_admin_bar .total_moves span').html( memory.stats.total_moves );

            }

        });

    }

    //INITIAL GAME SCREEN
    $('.memory').on('click','.generate_game_button', function() {
        memory.game_board.generate_game_board();
    });

    $('.memory').on('keypress', '.generate_game input', function(e) {
        if (e.keyCode == 13) {
            memory.game_board.generate_game_board();
        }
    });

    //RESET THE GAME BOARD
    $('.memory').on('click','.reset_button',function() {
        $('.game_board').empty();
        $('.generate_game').show();
        memory.cards.card_array = [];

        $('.game_admin_bar').hide();

        memory.stats.total_moves = 0;
        $('.game_admin_bar .total_moves span').html( memory.stats.total_moves );
    });

    </script>

  </body>
</html>
